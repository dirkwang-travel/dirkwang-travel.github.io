<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>旅。手札 | Travel Notebook</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;500;700;800&family=Zen+Maru+Gothic:wght@400;500;700&family=Noto+Serif+TC:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 全局變數 --- */
        :root {
            --bg-app: #F9F8F6; 
            --card-bg: #FFFFFF;
            --text-main: #44403F;
            --text-sub: #8D8B88;
            --border-color: #E6E3DE;
            --paper-bg: #fffdf5; 
            --line-color: #dcdcdc; 
            --accent-color: #8c1a30;
        }

        .h-dvh { height: 100vh; height: 100dvh; }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }

        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            background-color: var(--bg-app);
            color: var(--text-main);
            overflow: hidden; /* 螢幕模式下隱藏捲軸 */
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- 螢幕顯示樣式 (Screen Styles) --- */
        
        .app-header {
            background-color: rgba(249, 248, 246, 0.95);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 1.5rem 1.5rem 0.5rem 1.5rem;
            border-bottom: 1px solid transparent;
        }

        .dashboard-title-input {
            background: transparent;
            border: none;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: 0.05em;
            width: 100%;
            transition: all 0.2s;
            font-family: 'Noto Serif TC', serif;
        }
        .dashboard-title-input:hover { opacity: 0.7; }
        .dashboard-title-input:focus { outline: none; }

        .trip-card {
            background: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            height: 18rem;
            border: 1px solid var(--border-color);
        }

        .trip-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
            z-index: 10;
            border-color: #D4C6AA;
        }

        .card-cover-area {
            height: 55%;
            width: 100%;
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.06'/%3E%3C/svg%3E");
        }

        .card-info-area {
            flex: 1;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .add-trip-card {
            background-color: transparent;
            border: 1px dashed #C8C6C4;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9E9C99;
            transition: all 0.2s;
            height: 18rem;
            cursor: pointer;
        }
        .add-trip-card:hover {
            border-color: #8c1a30;
            color: #8c1a30;
            background-color: rgba(255,255,255,0.4);
        }

        .action-btn {
            width: 42px; height: 42px;
            border-radius: 50%;
            background: white;
            color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-color: #D4C6AA;
            color: #8c1a30;
        }
        .action-btn:active { transform: translateY(0); }

        .notebook-view-active body { background-color: #EADDCD !important; }

        .hand-drawn-input { background: transparent; border-bottom: 1px dashed #cccccc; font-family: 'Zen Maru Gothic', sans-serif; transition: border-color 0.3s; color: #555; border-radius: 0; }
        .hand-drawn-input:focus { outline: none; border-bottom-color: var(--accent-color); color: #333; }
        
        .paper-texture { 
            background-color: var(--paper-bg); 
            background-image: linear-gradient(var(--line-color) 1px, transparent 1px); 
            background-size: 100% 2rem; 
            background-attachment: local; 
            line-height: 2rem; 
            position: relative; 
            -webkit-overflow-scrolling: touch; 
        }
        .paper-texture::before { content: ''; position: absolute; top: 0; bottom: 0; left: 2rem; width: 1px; background-color: #e0e0e0; opacity: 0.8; z-index: 0; pointer-events: none; }
        @media (max-width: 640px) { .paper-texture::before { display: none; } .paper-texture { background-size: 100% 3rem; line-height: 3rem; } }
        
        .kraft-cover { background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E"); box-shadow: inset 10px 0 20px rgba(0,0,0,0.15), 5px 5px 15px rgba(0,0,0,0.2), 1px 1px 3px rgba(0,0,0,0.1); border-radius: 3px 10px 10px 3px; }
        
        .bookmark-tab { width: 100%; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 6px 0 0 6px; font-family: 'Zen Maru Gothic', sans-serif; font-weight: bold; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; position: relative; margin-bottom: 6px; box-shadow: -2px 2px 4px rgba(0,0,0,0.05); }
        .bookmark-func { background-color: #e8e6e1; color: #555; margin-bottom: 4px; height: 42px; }
        .bookmark-func.active { background-color: var(--paper-bg); color: var(--accent-color); width: 115%; z-index: 35; box-shadow: -3px 3px 8px rgba(0,0,0,0.1); border-left: 3px solid var(--accent-color); }
        .bookmark-day.active { background-color: var(--paper-bg); color: var(--text-main); width: 115%; z-index: 30; box-shadow: -3px 3px 8px rgba(0,0,0,0.1); border-left: 3px solid var(--text-main); }
        .bookmark-day.inactive { background-color: #d1cfc7; color: #777; transform: translateX(4px); border-right: 1px solid rgba(0,0,0,0.1); }
        .bookmark-day.inactive:hover { transform: translateX(0); background-color: #e2e0d8; }
        .bookmark-add { background-color: rgba(255,255,255,0.3); border: 2px dashed #aaa; color: #888; }
        
        .mobile-nav-item { flex-shrink: 0; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: bold; font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.2s; border: 1px solid transparent; display: flex; align-items: center; gap: 4px; color: #78716c; }
        .mobile-nav-item.active { background-color: white; color: var(--accent-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-color: #e5e5e5; }
        .mobile-nav-item.day-active { background-color: white; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-color: #e5e5e5; }

        .checklist-item { cursor: pointer; transition: all 0.2s; }
        .checklist-item.checked span { text-decoration: line-through; color: #aaa; }
        .checkmark { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px; margin-right: 10px; color: transparent; transition: all 0.2s; }
        .checklist-item.checked .checkmark { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }
        
        .boarding-pass { background: white; border-left: 6px solid var(--accent-color); position: relative; overflow: visible; }
        .boarding-pass::after { content: ''; position: absolute; right: 90px; top: 0; bottom: 0; width: 2px; border-right: 2px dashed #eee; pointer-events: none; }
        .flight-path { position: relative; height: 2px; background: #ddd; width: 100%; margin-top: 4px; }
        .flight-path i { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: white; padding: 0 4px; color: var(--accent-color); }
        @media (max-width: 640px) { .boarding-pass::after { right: 70px; } }

        .memo-accommodation { background-color: #f0f9ff; border-left: 4px solid #bae6fd; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s; }
        .memo-accommodation::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%) rotate(-1deg); width: 60px; height: 16px; background-color: rgba(186, 230, 253, 0.6); box-shadow: 0 1px 2px rgba(0,0,0,0.05); backdrop-filter: blur(1px); z-index: 20; border-radius: 1px; }
        .memo-day { background-color: #fff7ed; border: 1px solid #fed7aa; border-bottom: none; border-radius: 6px 6px 2px 2px; box-shadow: 2px -1px 3px rgba(0,0,0,0.03); transform: rotate(-1deg); position: relative; z-index: 5; }
        .memo-add { background-color: #f5f5f4; border: 2px dashed #d6d3d1; border-radius: 8px; color: #78716c; cursor: pointer; transition: all 0.2s; position: relative; box-shadow: 2px 2px 4px rgba(0,0,0,0.05); }
        .memo-add::after { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%) rotate(2deg); width: 40px; height: 12px; background-color: rgba(214, 211, 209, 0.5); border-radius: 1px; }

        /* 通用動畫 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.4s ease-out; }
        .slide-up-enter-from { opacity: 0; transform: translateY(50px); }
        .slide-up-leave-to { opacity: 0; transform: translateY(-20px); }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-content, .modal-leave-active .modal-content { transition: transform 0.3s ease; }
        .modal-enter-from .modal-content, .modal-leave-to .modal-content { transform: scale(0.95); }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .font-hand { font-family: 'Zen Maru Gothic', sans-serif; }

        /* --- Print Area (預設隱藏) --- */
        #print-area { display: none; }

        /* --- PDF 列印專用樣式 (修復版) --- */
        /* 修復：將背景圖案統一設定在 body，解決分頁空白與不連貫問題 */
        body.is-printing {
            background-color: #fffdf5 !important;
            /* 組合背景：一層是水平灰線(格線)，一層是垂直紅線(左側) */
            background-image: 
                linear-gradient(#e5e5e5 1px, transparent 1px),
                linear-gradient(90deg, transparent 25mm, #ffcccc 25mm, #ffcccc calc(25mm + 1px), transparent calc(25mm + 1px)) !important;
            background-size: 100% 10mm, 100% 100% !important;
            overflow: visible !important;
            height: auto !important;
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }
        
        body.is-printing #screen-area, 
        body.is-printing .modal { 
            display: none !important; 
        }

        body.is-printing #print-area { 
            display: block !important; 
        }

        @media print {
            @page { size: A4; margin: 0; }
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                /* 確保列印時 Body 擁有完整的背景與紋理 */
                background-color: #fffdf5 !important; 
                background-image: 
                    linear-gradient(#e5e5e5 1px, transparent 1px),
                    linear-gradient(90deg, transparent 25mm, #ffcccc 25mm, #ffcccc calc(25mm + 1px), transparent calc(25mm + 1px)) !important;
                background-size: 100% 10mm, 100% 100% !important;
            }
            #screen-area, .modal { display: none !important; }
            #print-area { display: block !important; }
        }

        /* 3. 封面樣式 (A4 滿版) */
        .print-cover {
            width: 210mm;
            height: 297mm;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            page-break-after: always;
            break-after: always;
            overflow: hidden;
            /* 封面因為有背景色，會自然蓋過 Body 的格線，無需額外處理 */
        }
        .print-cover h1 {
            font-size: 48pt;
            font-weight: 800;
            margin-bottom: 20pt;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: 'Noto Serif TC', serif;
        }
        .print-cover p {
            font-size: 18pt;
            opacity: 0.9;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            letter-spacing: 2px;
        }
        .print-cover::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* 4. 內頁樣式 (A4 頁面 - 修復版) */
        .print-page {
            width: 210mm;
            min-height: 297mm; /* 確保至少一頁 */
            height: auto; /* 允許自動延伸 */
            padding: 20mm;
            
            /* 移除原本個別頁面的背景設定，改由 body 繼承，確保跨頁連續性 */
            background-color: transparent; 
            
            position: relative;
            page-break-after: always;
            break-after: always; /* 強制換頁 */
            box-sizing: border-box;
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: visible !important; /* 重要：允許內容溢出到下一頁 */
            display: block;
        }
        
        /* 移除 .print-page::before (紅線)，因為已整合進 body 背景 */
        /*
        .print-page::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 25mm;
            width: 1px;
            background-color: #ffcccc;
            z-index: 0;
            height: 100%;
        }
        */

        .print-header {
            font-size: 24pt;
            font-weight: bold;
            color: #555;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            position: relative;
            z-index: 1;
            break-inside: avoid; /* 避免標題被切斷 */
        }
        .print-header span.date {
            font-size: 14pt;
            color: #888;
            font-weight: normal;
        }

        /* 住宿區塊 */
        .print-stay {
            background: rgba(255,255,255,0.8);
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
            margin-left: 10mm;
            position: relative;
            z-index: 1;
            break-inside: avoid; /* 避免內容被切斷 */
            page-break-inside: avoid;
        }
        .print-stay h3 {
            font-size: 12pt;
            color: #888;
            margin-bottom: 5px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .print-stay div.content {
            font-size: 16pt;
            color: #333;
            font-weight: bold;
        }

        /* 行程列表 */
        .print-item {
            display: flex;
            margin-bottom: 20px;
            margin-left: 10mm;
            position: relative;
            z-index: 1;
            background: rgba(255,255,255,0.6);
            padding: 5px;
            border-radius: 4px;
            break-inside: avoid; /* 避免行程項目被切斷 */
            page-break-inside: avoid;
        }
        .print-time-col {
            width: 80px; 
            padding-right: 15px;
            font-family: monospace;
            font-size: 12pt;
            font-weight: bold;
            color: #444;
            padding-top: 4px;
            text-align: right;
        }
        .print-content-col {
            flex: 1;
            border-left: 2px solid #ddd;
            padding-left: 24px; 
        }
        .print-title {
            font-size: 14pt;
            font-weight: bold;
            color: #222;
            margin-bottom: 2px;
        }
        .print-meta-row {
            font-size: 10pt;
            color: #666;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .print-cost {
            font-family: monospace;
            font-weight: bold;
            color: #8c1a30;
        }
        .print-note {
            font-size: 10pt;
            color: #888;
            font-style: italic;
            margin-top: 4px;
        }
        
        .print-page:last-child {
            page-break-after: auto;
            break-after: auto;
        }
    </style>
</head>
<body class="h-dvh w-full" :class="{'notebook-view-active': viewState === 'notebook', 'is-printing': isExporting}">

    <div id="app" class="relative w-full h-full flex flex-col">

        <!-- A. 螢幕顯示區 (Screen Area) -->
        <div id="screen-area" class="w-full h-full flex flex-col">
            <!-- 視圖 1: 現代化入口 (Dashboard) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewState === 'shelf'" class="w-full h-full flex flex-col overflow-y-auto hide-scroll relative z-10 safe-pb">
                    <div class="app-header max-w-7xl mx-auto w-full flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="w-full sm:w-auto flex-1 text-center sm:text-left">
                            <input v-model="appTitle" @change="saveAppTitle" class="dashboard-title-input text-gray-700" placeholder="我的旅程">
                            <p class="text-xs text-gray-400 mt-1 font-bold tracking-widest pl-1 font-sans">TRAVEL NOTEBOOK</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button @click="openManual" class="action-btn" title="說明"><i class="ph-bold ph-book-open-text text-lg"></i></button>
                            <button @click="showSettings = true" class="action-btn" title="設定"><i class="ph-bold ph-gear text-lg"></i></button>
                            <div class="h-6 w-px bg-[#D4C6AA] mx-1"></div>
                            <button @click="downloadBookshelf" class="action-btn" title="下載"><i class="ph-bold ph-cloud-arrow-down text-lg"></i></button>
                            <button @click="uploadBookshelf" class="action-btn bg-[#44403F] text-white hover:bg-[#2D2D2D] hover:text-white border-none" title="存檔"><i class="ph-bold ph-floppy-disk text-lg"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 w-full max-w-7xl mx-auto p-6 pb-20">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <div @click="createNewTrip" class="add-trip-card group">
                                <div class="w-16 h-16 rounded-full bg-[#E6E3DE] flex items-center justify-center mb-4 group-hover:scale-110 transition-transform group-hover:bg-[#D4C6AA]">
                                    <i class="ph-light ph-plus text-3xl text-gray-500 group-hover:text-[#44403F]"></i>
                                </div>
                                <span class="font-bold text-gray-400 group-hover:text-[#44403F] tracking-wider text-sm">建立新旅程</span>
                            </div>
                            <div v-for="trip in tripList" :key="trip.id" @click="switchTrip(trip.id)" class="trip-card group cursor-pointer">
                                <button @click.stop="openDeleteModal(trip.id)" class="absolute top-3 right-3 z-20 w-8 h-8 rounded-full bg-white/90 backdrop-blur shadow-sm text-gray-400 hover:text-[#7F0019] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                                <div class="card-cover-area" :style="{ backgroundColor: trip.color || '#D4C6AA' }"></div>
                                <div class="card-info-area">
                                    <div><h3 class="text-xl font-bold text-[#44403F] leading-tight line-clamp-2 mb-2 font-serif">{{ trip.destination || '未命名行程' }}</h3><div class="h-0.5 w-6 mt-2" :style="{ backgroundColor: trip.color || '#D4C6AA' }"></div></div>
                                    <div class="flex items-end justify-between mt-4"><div class="flex flex-col"><span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Start Date</span><span class="text-sm font-bold text-gray-500 font-hand">{{ trip.startDate }}</span></div><span class="bg-[#F2F0EB] text-[#8D8B88] px-2 py-1 rounded-sm text-xs font-bold tracking-wide">{{ trip.daysCount }} DAYS</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 視圖 2: 筆記本編輯模式 -->
            <transition name="slide-up">
                <div v-if="viewState === 'notebook'" class="absolute inset-0 z-20 bg-[#44403F]/20 sm:flex items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
                    <div class="w-full h-full max-w-5xl flex flex-col sm:flex-row shadow-2xl sm:rounded-lg overflow-hidden relative">
                        <!-- Sidebar -->
                        <div class="hidden sm:flex w-16 sm:w-20 pt-16 pb-4 flex-col items-end z-30 shrink-0 relative pointer-events-none">
                            <div class="pointer-events-auto w-full pr-0 flex flex-col gap-1 overflow-y-auto hide-scroll pb-10" style="direction: rtl;">
                                <div @click="changeViewMode('checklist')" :class="viewMode === 'checklist' ? 'active' : 'inactive'" class="bookmark-tab bookmark-func shadow-sm" style="direction: ltr;" title="行前準備"><i class="ph-bold ph-suitcase text-lg"></i></div>
                                <div @click="changeViewMode('money')" :class="viewMode === 'money' ? 'active' : 'inactive'" class="bookmark-tab bookmark-func shadow-sm mb-4" style="direction: ltr;" title="分帳模式"><i class="ph-bold ph-currency-dollar text-lg"></i></div>
                                <div v-for="(day, idx) in days" :key="idx" @click="changeDay(idx)" :class="[currentDayIdx === idx && viewMode === 'list' ? 'active' : 'inactive', 'bookmark-tab bookmark-day shadow-sm']" style="direction: ltr;"><span class="writing-mode-horizontal">D{{ idx + 1 }}</span></div>
                                <button @click="addDay" class="bookmark-tab bookmark-add inactive h-10" style="direction: ltr;" title="新增一天"><i class="ph-bold ph-plus text-lg"></i></button>
                            </div>
                        </div>
                        
                        <!-- Content Area -->
                        <div class="flex-1 bg-white flex flex-col relative z-20 shadow-xl overflow-hidden sm:rounded-lg w-full h-full">
                            <header class="kraft-cover relative z-10 p-4 pb-6 shadow-sm flex-shrink-0 border-b border-gray-200 safe-pt" :style="{ backgroundColor: currentTripColor || '#8D6E63' }">
                                <button @click="backToShelf" class="absolute top-4 left-4 sm:top-4 sm:left-4 safe-pt mt-2 sm:mt-0 text-white/90 hover:text-white bg-black/10 hover:bg-black/20 rounded-full p-1.5 transition z-20 flex items-center gap-1 pr-3 shadow-sm font-bold backdrop-blur-sm"><i class="ph-bold ph-arrow-left text-base"></i><span class="text-xs">返回</span></button>
                                <div class="absolute top-4 right-4 sm:top-4 sm:right-4 safe-pt mt-2 sm:mt-0 z-20 flex flex-col gap-2">
                                    <button @click="openEditTripModal" class="text-white/90 hover:text-white bg-black/10 hover:bg-black/20 rounded-full p-1.5 transition shadow-sm backdrop-blur-sm" title="編輯旅程資訊"><i class="ph-bold ph-pencil-simple text-base"></i></button>
                                    <button @click="exportToPDF" class="text-white/90 hover:text-white bg-black/10 hover:bg-black/20 rounded-full p-1.5 transition shadow-sm backdrop-blur-sm" title="匯出 PDF"><i class="ph-bold ph-printer text-base"></i></button>
                                    <!-- 新增存檔按鈕 -->
                                    <button @click="saveDataAndUpload" class="text-white/90 hover:text-white bg-black/10 hover:bg-black/20 rounded-full p-1.5 transition shadow-sm backdrop-blur-sm" title="儲存行程"><i class="ph-bold ph-floppy-disk text-base"></i></button>
                                </div>
                                <div class="absolute -bottom-2 left-0 w-full h-4 bg-repeat-x opacity-30" style="background-image: radial-gradient(circle, #000 2px, transparent 2.5px); background-size: 10px 10px;"></div>
                                <div class="max-w-2xl mx-auto pt-10 sm:pt-8 text-center sm:text-left pl-0 sm:pl-12">
                                    <div class="flex flex-col sm:flex-row justify-between items-center sm:items-start gap-4">
                                        <div><h1 class="text-2xl sm:text-4xl font-bold text-white tracking-tight flex items-center justify-center sm:justify-start gap-2 drop-shadow-md"><span class="border-b-2 border-white/20 pb-1">{{ setup.destination || 'My Trip' }}</span></h1><p class="mt-2 font-hand text-white/80 font-bold text-base sm:text-lg tracking-wider"><i class="ph-bold ph-calendar-blank"></i> {{ setup.startDate }} <span v-if="viewMode !== 'list'" class="ml-2 text-sm bg-white/20 px-2 py-0.5 rounded">{{ viewMode === 'money' ? '支出分類統計' : '行前清單' }}</span></p></div>
                                        <div class="bg-white/90 p-2 sm:p-3 rounded-sm shadow-sm border border-gray-100 min-w-[100px]"><div class="text-center"><div class="text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold">Total Cost</div><div class="font-hand font-bold text-lg sm:text-xl text-gray-700">$ {{ totalCost.toLocaleString() }}</div></div></div>
                                    </div>
                                </div>
                            </header>

                            <div class="flex-1 overflow-y-auto paper-texture relative pb-20 sm:pb-0" id="notebook-content">
                                <div v-if="viewMode === 'list'" class="max-w-3xl mx-auto p-4 sm:p-8 sm:pl-10 pb-32 min-h-full flex flex-col">
                                    <div v-if="isLoading" class="absolute inset-0 z-50 bg-white/90 flex items-center justify-center"><div class="text-center"><i class="ph-duotone ph-pencil-simple-slash text-4xl animate-bounce text-gray-400"></i><p class="mt-2 font-hand font-bold text-gray-500">翻頁中...</p></div></div>
                                    <div v-else-if="days.length === 0" class="text-center mt-12 text-gray-400"><p>載入中或無資料...</p></div>
                                    <div v-if="days.length > 0" class="flex-1">
                                         <div v-for="(day, dayIdx) in days" :key="dayIdx" v-show="dayIdx === currentDayIdx">
                                            <!-- Interactive Day Content -->
                                            <div class="flex justify-between items-end mb-6 border-b-2 border-gray-200 pb-2">
                                                <div class="memo-day inline-block px-4 py-2 shadow-sm w-full sm:max-w-[85%]"><div class="flex items-baseline gap-2"><span class="font-bold text-xl sm:text-2xl text-gray-700 font-hand">Day {{ dayIdx + 1 }}</span><input v-model="day.date" class="bg-transparent border-b border-gray-300 w-32 font-hand text-sm focus:outline-none text-gray-500" placeholder="日期 (MM/DD)"></div></div><button @click="confirmRemoveDay(dayIdx)" class="text-gray-300 hover:text-red-400 p-2 transition shrink-0" title="刪除這一天"><i class="ph-bold ph-trash"></i></button>
                                            </div>
                                            <!-- Accommodation Editor -->
                                            <div v-if="day.accommodationType === 'flight'" class="sm:ml-8 mb-6 boarding-pass rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition relative p-0 z-10 w-full sm:max-w-[85%]">
                                                <div @click="toggleAccommodationType(dayIdx)" class="absolute -left-2 sm:-left-3 top-4 w-6 h-6 bg-blue-50 hover:bg-blue-100 rounded-full flex items-center justify-center text-blue-400 hover:text-blue-600 border border-blue-100 shadow-sm z-50 cursor-pointer transition"><i class="ph-fill ph-airplane-tilt"></i></div>
                                                <div class="bg-gray-50 px-4 py-2 border-b border-dashed border-gray-200 flex justify-between items-center pl-6 sm:pl-8"><div class="flex items-center gap-2 sm:gap-3 w-2/3"><i class="ph-fill ph-moon text-accent-color"></i><span class="text-xs font-bold text-gray-400 whitespace-nowrap hidden sm:inline">機上過夜</span><input v-model="day.airline" class="bg-transparent text-sm font-bold text-gray-700 w-full outline-none placeholder-gray-400 min-w-0" placeholder="航空公司"></div><div class="w-1/3 text-right flex items-center justify-end gap-1 z-20"><i class="ph-duotone ph-coins text-gray-400 text-xs"></i><input v-model.number="day.accommodationCost" type="number" class="bg-transparent text-sm font-mono text-gray-600 w-16 sm:w-20 outline-none text-right placeholder-gray-300" placeholder="0"></div></div>
                                                <div class="p-3 sm:p-4 flex items-center pl-6 sm:pl-8"><div class="flex-1 flex items-center justify-between gap-1 sm:gap-2"><div class="text-center w-1/3 flex flex-col gap-1"><input v-model="day.origin" class="bg-transparent text-xl sm:text-2xl font-black text-gray-800 w-full outline-none text-center uppercase placeholder-gray-200" placeholder="DEP" maxlength="3"><input v-model="day.time" @change="validateTime(day)" class="bg-transparent text-xs text-gray-500 w-full outline-none text-center font-mono" placeholder="起飛"></div><div class="flex-1 flex flex-col items-center justify-center px-1"><input v-model="day.flightNo" class="bg-transparent text-[10px] font-bold text-gray-500 w-full outline-none text-center mb-0.5" placeholder="航班"><div class="flight-path"><i class="ph-fill ph-airplane text-gray-300 text-xs transform rotate-90"></i></div></div><div class="text-center w-1/3 flex flex-col gap-1 items-center"><input v-model="day.destination" class="bg-transparent text-xl sm:text-2xl font-black text-gray-800 w-full outline-none text-center uppercase placeholder-gray-200" placeholder="ARR" maxlength="3"><div class="flex items-center justify-center gap-1 w-full relative"><input v-model="day.arrivalTime" @change="validateTimeSimple(day, 'arrivalTime')" class="bg-transparent text-xs text-gray-500 w-full outline-none text-center font-mono" placeholder="抵達"><button v-if="day.arrivalTime" type="button" @click="cycleArrivalOffset(day)" class="absolute left-[80%] sm:left-[60%] ml-0 sm:ml-3 top-0 text-[9px] font-bold transition-colors px-1 rounded whitespace-nowrap" :class="day.arrivalOffset > 0 ? 'text-red-500 bg-red-50' : 'text-gray-300 hover:text-gray-400'">{{ day.arrivalOffset > 0 ? '+' + day.arrivalOffset : '(+n)' }}</button></div></div></div><div class="ticket-separator self-stretch mx-2 sm:mx-0"></div><div class="w-14 sm:w-20 flex flex-col gap-1 items-center justify-center"><label class="text-[9px] text-gray-400 hidden sm:block">飛行時間</label><input v-model="day.flightDuration" @change="validateDuration(day)" class="bg-transparent text-xs sm:text-sm font-mono font-bold text-gray-700 w-full outline-none text-center" placeholder="時長"></div></div>
                                            </div>
                                            <div v-else class="memo-accommodation sm:ml-8 mb-6 p-4 z-10 w-full sm:max-w-[85%]">
                                                <div @click="toggleAccommodationType(dayIdx)" class="absolute -left-2 sm:-left-3 top-4 w-6 h-6 bg-blue-50 hover:bg-blue-100 rounded-full flex items-center justify-center text-blue-400 hover:text-blue-600 border border-blue-100 shadow-sm z-50 cursor-pointer transition"><i class="ph-fill ph-bed"></i></div>
                                                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center"><div class="flex-1 w-full"><label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Accommodation</label><input v-model="day.accommodation" class="hand-drawn-input w-full text-lg text-gray-700 font-bold" placeholder="今晚住哪裡？"></div><div class="w-full sm:w-32"><label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Cost</label><input v-model.number="day.accommodationCost" type="number" class="hand-drawn-input w-full text-right font-mono text-gray-600" placeholder="0"></div></div>
                                            </div>
                                            <!-- Items -->
                                            <div class="space-y-4 sm:pl-8 sm:border-l sm:border-dashed sm:border-gray-300 sm:ml-3 mb-12">
                                                <div v-for="(item, iIdx) in day.items" :key="iIdx" class="relative group/item">
                                                    <div class="hidden sm:block absolute -left-[2.3rem] top-3 w-3 h-3 rounded-full border border-white shadow-sm z-10" :class="getTypeColor(item.type)"></div>
                                                    <!-- Standard Item -->
                                                    <div v-if="item.type !== 'flight'" class="bg-white p-3 rounded-md shadow-sm border border-gray-100 hover:shadow-md transition relative z-0">
                                                        <div class="flex gap-3"><div class="flex flex-col gap-2 w-20 sm:w-24 shrink-0"><input v-model="item.time" @change="validateTime(item)" type="text" maxlength="5" placeholder="HH:mm" class="bg-gray-50 rounded px-1 py-1 text-sm font-mono font-bold text-gray-600 border border-gray-200 focus:border-gray-400 outline-none text-center"><div class="relative"><select v-model="item.type" class="w-full text-xs bg-gray-50 rounded px-1 py-1 text-center font-hand text-gray-500 cursor-pointer border border-transparent hover:border-gray-300 focus:outline-none appearance-none"><option value="spot">景點</option><option value="food">美食</option><option value="shop">活動</option><option value="transport">交通</option><option value="flight">飛航</option></select><i class="ph-caret-down absolute right-1 top-1.5 text-[10px] text-gray-400 pointer-events-none"></i></div></div><div class="flex-1 min-w-0 grid gap-2"><input v-model="item.activity" class="font-bold text-lg text-gray-700 bg-transparent border-none p-0 focus:ring-0 placeholder-gray-300 w-full" placeholder="做什麼呢？"><div class="flex items-center gap-2"><i class="ph-duotone ph-map-pin text-gray-400"></i><input v-model="item.location" class="flex-1 text-sm text-gray-600 bg-transparent border-b border-dashed border-transparent hover:border-gray-300 focus:border-gray-400 focus:outline-none transition" placeholder="地點"></div><div class="flex items-center gap-2"><i class="ph-duotone ph-coins text-gray-400"></i><input v-model.number="item.cost" type="number" class="w-24 text-sm font-mono text-gray-600 bg-transparent border-b border-dashed border-transparent hover:border-gray-300 focus:border-gray-400 focus:outline-none text-right transition" placeholder="金額"></div><input v-model="item.note" class="text-xs text-gray-400 bg-transparent w-full italic font-hand placeholder-gray-200" placeholder="寫點備註..."></div><button @click="removeItem(dayIdx, iIdx)" class="text-gray-300 hover:text-red-400 self-start p-1"><i class="ph-bold ph-x"></i></button></div>
                                                    </div>
                                                    <!-- Flight Item (Small) -->
                                                    <div v-else class="boarding-pass rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition relative p-0 z-0">
                                                        <div class="bg-gray-50 px-4 py-2 border-b border-dashed border-gray-200 flex justify-between items-center"><div class="flex items-center gap-2 w-1/2"><i class="ph-fill ph-airplane-tilt text-accent-color"></i><input v-model="item.airline" class="bg-transparent text-sm font-bold text-gray-700 w-full outline-none placeholder-gray-400" placeholder="航空公司"></div><div class="w-1/2 text-right flex items-center justify-end gap-2 relative z-20"><div class="flex items-center gap-1 pl-2"><i class="ph-duotone ph-coins text-gray-400 text-xs"></i><input v-model.number="item.cost" type="number" class="bg-transparent text-sm font-mono text-gray-600 w-16 outline-none text-right placeholder-gray-300" placeholder="0"></div></div></div>
                                                        <div class="p-3 sm:p-4 flex items-center relative"><div class="absolute top-2 left-2 sm:left-4 w-16 z-30"><div class="relative"><select v-model="item.type" class="w-full text-xs bg-transparent text-gray-400 cursor-pointer focus:outline-none appearance-none pr-3 font-bold hover:text-gray-600"><option value="flight">飛航</option><option value="transport">交通</option><option value="food">美食</option><option value="shop">活動</option><option value="spot">景點</option></select><i class="ph-caret-down absolute right-2 top-0.5 text-[10px] text-gray-300 pointer-events-none"></i></div></div><div class="flex-1 flex items-center justify-between gap-1 sm:gap-2 mt-4"><div class="text-center w-1/3 flex flex-col gap-1"><input v-model="item.origin" class="bg-transparent text-xl sm:text-2xl font-black text-gray-800 w-full outline-none text-center uppercase placeholder-gray-200" placeholder="DEP" maxlength="3"><input v-model="item.time" @change="validateTime(item)" class="bg-transparent text-xs text-gray-500 w-full outline-none text-center font-mono" placeholder="起飛"></div><div class="flex-1 flex flex-col items-center justify-center px-1"><input v-model="item.flightNo" class="bg-transparent text-[10px] font-bold text-gray-500 w-full outline-none text-center mb-0.5" placeholder="航班"><div class="flight-path-container"><div class="flight-line"></div><div class="flight-icon-wrapper"><i class="ph-fill ph-airplane text-gray-300 text-xs transform rotate-90"></i></div></div></div><div class="text-center w-1/3 flex flex-col gap-1 items-center"><input v-model="item.destination" class="bg-transparent text-xl sm:text-2xl font-black text-gray-800 w-full outline-none text-center uppercase placeholder-gray-200" placeholder="ARR" maxlength="3"><div class="flex items-center justify-center gap-1 w-full relative"><input v-model="item.arrivalTime" @change="validateTimeSimple(item, 'arrivalTime')" class="bg-transparent text-xs text-gray-500 w-full outline-none text-center font-mono" placeholder="抵達"><button v-if="item.arrivalTime" type="button" @click="cycleArrivalOffset(item)" class="absolute left-[80%] sm:left-[60%] ml-0 sm:ml-3 top-0 text-[9px] font-bold transition-colors px-1 rounded whitespace-nowrap" :class="item.arrivalOffset > 0 ? 'text-red-500 bg-red-50' : 'text-gray-300 hover:text-gray-400'">{{ item.arrivalOffset > 0 ? '+' + item.arrivalOffset : '(+n)' }}</button></div></div></div><div class="ticket-separator self-stretch mx-2 sm:mx-0"></div><div class="w-14 sm:w-20 flex flex-col gap-1 items-center justify-center"><label class="text-[9px] text-gray-400 hidden sm:block">飛行時間</label><input v-model="item.flightDuration" @change="validateDuration(item)" class="bg-transparent text-xs sm:text-sm font-mono font-bold text-gray-700 w-full outline-none text-center" placeholder="時長"></div><button @click="removeItem(dayIdx, iIdx)" class="absolute top-1 right-1 text-gray-200 hover:text-red-400 p-1"><i class="ph-bold ph-x"></i></button></div>
                                                    </div>
                                                </div>
                                                <button @click="addItem(dayIdx)" class="memo-add sm:ml-4 flex items-center gap-2 text-sm font-bold font-hand group py-2 w-full sm:w-32 justify-center sm:max-w-[85%] mt-4 sm:mt-0"><i class="ph-bold ph-plus"></i> 新增行程</button>
                                            </div>
                                         </div>
                                    </div>
                                </div>
                                <!-- Checklist & Money -->
                                <div v-if="viewMode === 'checklist'" class="max-w-3xl mx-auto p-4 sm:p-8 pt-10 font-hand pb-32">
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative mb-8" :class="{'border-dashed border-accent-color': isChecklistEditing}"><div class="absolute -top-3 left-1/2 -translate-x-1/2 w-32 h-6 bg-gray-100 border border-gray-200 -rotate-1 rounded-sm z-0"></div><div class="flex justify-between items-center mb-6 border-b-2 border-dashed border-gray-300 pb-4 relative z-10"><h2 class="text-2xl font-bold text-gray-700">行前準備清單</h2><button @click="toggleChecklistEdit" class="text-gray-500 hover:text-accent-color transition" :title="isChecklistEditing ? '完成編輯' : '編輯清單'"><i :class="['ph-bold', isChecklistEditing ? 'ph-check text-2xl text-green-600' : 'ph-pencil-simple text-xl']"></i></button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div v-for="(items, category) in checklistData" :key="category" class="relative"><div class="flex justify-between items-center mb-3 border-b border-gray-200 pb-1"><h3 class="text-lg font-bold text-accent-color">{{ category }}</h3><button v-if="isChecklistEditing" @click="removeChecklistCategory(category)" class="text-red-300 hover:text-red-500"><i class="ph-bold ph-x"></i></button></div><ul class="space-y-2"><li v-for="(item, idx) in items" :key="idx" @click="!isChecklistEditing && toggleCheckItem(item)" class="checklist-item flex items-center text-sm p-3 sm:p-1 rounded relative group/item" :class="{ 'checked': !isChecklistEditing && checklist.includes(item) }"><div v-if="isChecklistEditing" class="flex items-center w-full gap-2"><input v-model="items[idx]" class="flex-1 bg-transparent border-b border-gray-300 text-gray-700 text-sm focus:border-accent-color outline-none"><button @click="removeChecklistItem(category, idx)" class="text-gray-300 hover:text-red-500"><i class="ph-bold ph-x"></i></button></div><div v-else class="flex items-center w-full"><div class="checkmark"><i class="ph-bold ph-check text-xs"></i></div><span class="text-gray-700 font-bold transition-all text-base sm:text-sm">{{ item }}</span></div></li></ul><div v-if="isChecklistEditing" class="mt-2 text-center"><button @click="addChecklistItem(category)" class="text-xs text-gray-400 hover:text-accent-color border border-dashed border-gray-300 hover:border-accent-color px-2 py-1 rounded">+ 新增項目</button></div></div></div><div v-if="isChecklistEditing" class="mt-8 pt-4 border-t border-dashed border-gray-200 text-center"><button @click="addChecklistCategory" class="text-sm text-gray-500 hover:text-gray-800 font-bold border-2 border-dashed border-gray-300 hover:border-gray-500 px-4 py-2 rounded-lg w-full"><i class="ph-bold ph-plus"></i> 新增分類</button></div></div>
                                </div>
                                <div v-if="viewMode === 'money'" class="max-w-3xl mx-auto p-4 sm:p-8 pt-10 font-hand pb-32">
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative"><div class="absolute -top-3 left-1/2 -translate-x-1/2 w-8 h-12 border-4 border-gray-300 rounded-full z-10" style="border-bottom: none; height: 20px;"></div><h2 class="text-2xl font-bold text-gray-700 mb-6 text-center border-b-2 border-dashed border-gray-200 pb-4">旅程支出分類統計</h2><div class="flex justify-between items-center mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100"><label class="text-gray-500 font-bold">分帳人數：</label><div class="flex items-center gap-2"><button @click="participants > 1 ? participants-- : null" class="w-10 h-10 sm:w-8 sm:h-8 rounded bg-white border border-gray-300 text-gray-500 hover:bg-gray-100 font-bold">-</button><span class="font-mono text-xl font-bold w-8 text-center text-gray-700">{{ participants }}</span><button @click="participants++" class="w-10 h-10 sm:w-8 sm:h-8 rounded bg-white border border-gray-300 text-gray-500 hover:bg-gray-100 font-bold">+</button></div></div><div class="space-y-6 mb-6 overflow-y-auto max-h-[50vh] pr-2"><div v-for="(cat, key) in categoryExpenses" :key="key" v-show="cat.total > 0" class="border border-gray-100 rounded-lg p-3 shadow-sm bg-white"><div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2"><div class="flex items-center gap-2"><div :class="['w-8 h-8 rounded-full flex items-center justify-center', cat.bg, cat.color]"><i :class="['ph-duotone', cat.icon, 'text-lg']"></i></div><span class="font-bold text-gray-600">{{ cat.label }}</span></div><span class="font-mono font-bold text-lg text-gray-700">$ {{ cat.total.toLocaleString() }}</span></div><div class="space-y-1 pl-2"><div v-for="(item, i) in cat.list" :key="i" class="flex justify-between text-sm text-gray-500 hover:bg-gray-50 p-1 rounded"><span class="truncate max-w-[220px]">{{ item.desc }}</span><span class="font-mono text-gray-600">$ {{ item.cost.toLocaleString() }}</span></div></div></div><div v-if="tripTotalExpense === 0" class="text-center text-gray-400 py-4">尚未有任何支出紀錄</div></div><div class="bg-[#F4F2EE] p-4 rounded-lg mt-4 space-y-2 border border-gray-200"><div class="flex justify-between text-gray-600 font-bold"><span>全旅程總計</span><span class="text-xl font-mono">$ {{ tripTotalExpense.toLocaleString() }}</span></div><div class="flex justify-between text-gray-500 text-sm border-t border-gray-300 pt-2"><span>每人平均分擔</span><span class="font-mono text-lg text-accent-color font-bold">$ {{ Math.ceil(tripTotalExpense / participants).toLocaleString() }}</span></div></div></div>
                                </div>
                            </div>
                            <div class="sm:hidden fixed bottom-0 left-0 w-full bg-[#f0eeeb] border-t border-[#dcdcdc] z-[200] safe-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex items-center gap-1 overflow-x-auto hide-scroll px-2 py-2">
                                <button @click="changeViewMode('checklist')" :class="['mobile-nav-item', viewMode === 'checklist' ? 'active' : '']"><i class="ph-bold ph-suitcase text-lg"></i><span>清單</span></button>
                                <button @click="changeViewMode('money')" :class="['mobile-nav-item', viewMode === 'money' ? 'active' : '']"><i class="ph-bold ph-currency-dollar text-lg"></i><span>分帳</span></button>
                                <div class="w-px h-6 bg-gray-300 mx-1 flex-shrink-0"></div>
                                <div class="flex gap-1"><button v-for="(day, idx) in days" :key="idx" @click="changeDay(idx)" :class="['mobile-nav-item', currentDayIdx === idx && viewMode === 'list' ? 'day-active' : '']">D{{ idx + 1 }}</button></div>
                                <button @click="addDay" class="mobile-nav-item text-gray-400 hover:text-gray-600"><i class="ph-bold ph-plus text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
        </div>

        <!-- B. 列印顯示區 (Print Only Area) -->
        <div id="print-area">
            <!-- 1. 封面 -->
            <div class="print-cover" :style="{ backgroundColor: currentTripColor || '#8D6E63' }">
                <div class="print-texture-overlay"></div>
                <h1>{{ setup.destination || 'My Trip' }}</h1>
                <p>{{ setup.startDate }}</p>
            </div>

            <!-- 2. 內頁 -->
            <div class="print-page" v-for="(day, idx) in days" :key="idx" ref="printPages">
                <div class="print-page-line"></div>
                
                <div class="print-header">
                    <span class="day-title">Day {{ idx + 1 }}</span>
                    <span class="date-title">{{ day.date }}</span>
                </div>

                <!-- 住宿或過夜飛機 (Fix: 顯示完整航班資訊) -->
                <div v-if="day.accommodation || day.accommodationType === 'flight'" class="print-stay">
                    <h3>{{ day.accommodationType === 'flight' ? 'Overnight Flight' : 'Accommodation' }}</h3>
                    <div class="print-stay-content">
                        <!-- Case 1: 機上過夜 - 顯示完整航班資訊 -->
                        <div v-if="day.accommodationType === 'flight'" class="flex flex-col gap-1">
                            <div class="font-bold text-lg text-gray-700">{{ day.airline }} {{ day.flightNo }}</div>
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <span class="font-mono bg-gray-100 px-1 rounded">{{ day.origin }}</span>
                                <span class="font-mono font-bold">{{ day.time }}</span>
                                <i class="ph-bold ph-airplane-takeoff text-gray-400"></i>
                                <span class="font-mono font-bold">{{ day.arrivalTime }}</span>
                                <span class="font-mono bg-gray-100 px-1 rounded">{{ day.destination }}</span>
                                <span v-if="day.arrivalOffset" class="text-xs text-red-500 font-bold">(+{{ day.arrivalOffset }})</span>
                            </div>
                            <div class="text-xs text-gray-400">飛行時長: {{ day.flightDuration }}</div>
                        </div>
                        
                        <!-- Case 2: 一般住宿 -->
                        <div v-else class="content flex justify-between">
                            <span>{{ day.accommodation }}</span>
                            <span class="print-stay-cost" v-if="day.accommodationCost > 0">$ {{ day.accommodationCost }}</span>
                        </div>
                    </div>
                    <!-- 補上 Flight Cost 顯示 -->
                    <div v-if="day.accommodationType === 'flight' && day.accommodationCost > 0" class="absolute top-4 right-4 print-stay-cost text-lg">
                        $ {{ day.accommodationCost }}
                    </div>
                </div>
                
                <!-- 行程清單 -->
                <div class="print-timeline" v-if="day.items && day.items.length > 0">
                    <div class="print-item" v-for="(item, iIdx) in day.items" :key="iIdx">
                        <div class="print-time-col">{{ item.time || '--:--' }}</div>
                        <div class="print-content-col">
                            <div class="print-title">{{ item.activity || item.airline + ' ' + item.flightNo }}</div>
                            <div class="print-meta-row">
                                <div class="print-meta-item" v-if="item.location">📍 {{ item.location }}</div>
                                <div class="print-meta-item" v-if="item.type">🏷️ {{ getCategoryName(item.type) }}</div>
                                <div class="print-meta-item print-cost" v-if="item.cost > 0">$ {{ item.cost }}</div>
                            </div>
                            <div v-if="item.note" class="print-note">{{ item.note }}</div>
                        </div>
                    </div>
                </div>
                <div v-else class="text-gray-400 italic text-center mt-10">No activities scheduled.</div>
            </div>
        </div>

        <!-- Modals -->
        <transition name="modal">
            <div v-if="showDeleteModal" class="modal fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[150] flex items-center justify-center p-4">
                <div class="modal-content bg-white w-full max-w-sm rounded-lg shadow-xl p-6 text-center border border-gray-100 relative">
                    <div class="w-14 h-14 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph-duotone ph-trash text-2xl text-gray-500"></i></div><h3 class="text-lg font-bold text-gray-800 mb-2">{{ deleteTitle }}</h3><p class="text-gray-500 text-sm mb-6">{{ deleteMessage }}</p>
                    <div class="grid grid-cols-2 gap-3"><button @click="closeDeleteModal" class="py-2.5 px-4 rounded-md bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition text-sm">取消</button><button @click="confirmDeleteAction" class="py-2.5 px-4 rounded-md bg-gray-700 text-white font-bold hover:bg-gray-800 shadow-sm transition text-sm">確認刪除</button></div>
                </div>
            </div>
        </transition>
        
        <!-- Settings/Manual Modals (Reused) -->
        <div v-if="showManualModal || showSettings || showSetupModal || showEditTripModal" class="modal fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-pt">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[85vh]">
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <i class="ph-duotone ph-gear"></i> 
                        {{ showManualModal ? '使用說明' : (showSetupModal ? '建立新旅程' : (showEditTripModal ? '編輯旅程資訊' : '設定')) }}
                    </h2>
                    <button @click="closeSettings" class="text-gray-400 hover:text-gray-600"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
                <div class="p-6 overflow-y-auto font-hand">
                     <!-- Manual Content -->
                    <div v-if="showManualModal">
                         <div class="flex border-b border-gray-200 mb-4"><button @click="manualTab = 'setup'" class="flex-1 py-3 text-sm font-bold transition" :class="manualTab === 'setup' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'">後端設定</button><button @click="manualTab = 'sync'" class="flex-1 py-3 text-sm font-bold transition" :class="manualTab === 'sync' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'">跨裝置同步</button></div>
                         <div v-if="manualTab === 'setup'" class="space-y-4"><p>若要啟用雲端備份功能，請依照以下步驟建立 Google Apps Script 後端：</p><ol class="list-decimal pl-5 space-y-2"><li>前往 <a href="https://sheet.new" target="_blank" class="text-blue-500 underline">Google Sheet</a> 建立一個新的試算表。</li><li>點選上方選單的 <strong>擴充功能 (Extensions)</strong> > <strong>Apps Script</strong>。</li><li>將代碼完全覆蓋編輯器內容，並點擊儲存 (磁碟片圖示)。</li><li>點選右上角的 <strong>部署 (Deploy)</strong> > <strong>新增部署作業 (New deployment)</strong>。</li><li>點選左側齒輪圖示 > 選擇 <strong>網頁應用程式 (Web app)</strong>。</li><li><strong>重要：</strong>將「存取權限 (Who has access)」設為 <strong>任何人 (Anyone)</strong>。</li><li>點擊部署，複製產生的 <strong>網頁應用程式網址 (Web App URL)</strong>。</li><li>回到本網頁，點擊右上角 <strong>設定 (齒輪)</strong>，將網址貼入並儲存。</li></ol></div>
                         <div v-if="manualTab === 'sync'"><p>1. 在原裝置點擊「存檔」。<br>2. 在新裝置設定頁貼上 GAS 網址。<br>3. 點擊「從雲端下載書架」。</p></div>
                    </div>
                    
                    <!-- Setup Content -->
                    <div v-if="showSetupModal">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-gray-300 pl-2">旅程資訊</h3>
                        <div class="flex flex-col gap-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">目的地</label><input v-model="setup.destination" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:border-gray-500 outline-none text-gray-700"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">出發日期</label><input v-model="setup.startDate" type="date" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 outline-none text-gray-700"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">天數</label><input v-model.number="setup.days" type="number" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 outline-none text-gray-700"></div></div>
                        <div class="pt-4 border-t border-gray-200 mt-4"><button @click="initTrip" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-3 rounded-lg font-bold transition">開始規劃旅程</button></div>
                    </div>

                    <!-- Edit Trip Content -->
                    <div v-if="showEditTripModal">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-accent-color pl-2">編輯旅程詳細資訊</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">目的地 (標題)</label><input v-model="editingTrip.destination" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:border-gray-500 outline-none text-gray-700"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">出發日期 (修正日期將同步更新內頁)</label><input v-model="editingTrip.startDate" type="date" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 outline-none text-gray-700"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">天數 (將自動增減頁面)</label><input v-model.number="editingTrip.days" type="number" min="1" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 outline-none text-gray-700"></div>
                            
                            <!-- 配色選擇器 -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2">封面配色</label>
                                <div class="flex gap-3 flex-wrap">
                                    <button 
                                        v-for="color in BOOK_COLORS" 
                                        :key="color"
                                        @click="editingTrip.color = color"
                                        class="w-8 h-8 rounded-full border border-gray-200 shadow-sm transition-transform hover:scale-110 relative"
                                        :style="{ backgroundColor: color }"
                                    >
                                        <!-- Checkmark -->
                                        <i v-if="editingTrip.color === color" class="ph-bold ph-check text-white absolute inset-0 m-auto flex items-center justify-center text-lg drop-shadow-md"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-gray-200 mt-4 flex gap-3">
                            <button @click="closeSettings" class="flex-1 py-3 text-gray-500 bg-gray-100 rounded-lg font-bold hover:bg-gray-200">取消</button>
                            <button @click="confirmEditTrip" class="flex-1 bg-gray-700 hover:bg-gray-800 text-white py-3 rounded-lg font-bold transition shadow-sm">確認修正</button>
                        </div>
                    </div>

                    <!-- Settings Content -->
                    <div v-if="showSettings && !showSetupModal && !showManualModal && !showEditTripModal">
                        <div class="space-y-2"><label class="block text-xs font-bold text-gray-500">Apps Script Web App URL</label><input v-model="googleScriptUrl" placeholder="https://script.google.com/macros/s/..../exec" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-xs font-mono text-gray-600 focus:border-gray-500 outline-none"><p class="text-[10px] text-gray-400">若留空則使用瀏覽器暫存 (Local Storage)。</p></div>
                        <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-2 mt-4"><button @click="closeSettings" class="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-md font-bold text-sm">取消</button><button @click="saveSettingsAndTrip" class="px-6 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-md font-bold shadow-sm text-sm">儲存設定</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        const { createApp, ref, computed, watch, onMounted, reactive, nextTick } = Vue;

        const BOOK_COLORS = ['#8c1a30', '#1f1e1c', '#4c6b8a', '#c7bfba', '#90a28d', '#f4f2ee'];
        
        const DEFAULT_CHECKLIST_STRUCTURE = {
            "化妝品": ["防曬/隔離", "氣墊粉底/粉底液", "遮瑕", "蜜粉", "刷具", "眼影", "腮紅", "定妝噴霧", "睫毛夾", "睫毛底膏", "睫毛膏", "磁吸睫毛", "口紅"],
            "髮品": ["梳子", "髮圈", "髮油", "電棒", "長髮夾", "髮飾", "定型噴霧"],
            "保養品": ["卸妝油", "化妝水", "面膜", "精華", "眼霜", "乳液", "潤膚乳液", "唇油"],
            "其他美容用品": ["美甲片", "果凍膠", "酒精棉片", "漱口水", "牙線", "耳環", "隱形眼鏡", "眼鏡"]
        };

        createApp({
            setup() {
                // --- Fix: Timezone Helper Function ---
                const getLocalISOString = () => {
                    const now = new Date();
                    // 扣除時區偏差 (例如 UTC+8，offset 是 -480 分鐘，減去負數等於加上 8 小時)
                    const offsetMs = now.getTimezoneOffset() * 60000;
                    const localTime = new Date(now.getTime() - offsetMs);
                    return localTime.toISOString().split('T')[0];
                };

                const viewState = ref('shelf');
                const viewMode = ref('list'); 
                const showSettings = ref(false);
                const showSetupModal = ref(false);
                const showEditTripModal = ref(false);
                const isLoading = ref(false);
                const isSaving = ref(false);
                const saveStatus = ref('');
                const appTitle = ref('我的旅遊書架');
                const participants = ref(1);
                const showManualModal = ref(false);
                const manualTab = ref('setup');
                const showDeleteModal = ref(false);
                const deleteTargetType = ref(null); 
                const deleteTargetId = ref(null);
                const deleteTitle = ref('');
                const deleteMessage = ref('');
                const tripList = ref([]);
                const currentTripId = ref(null);
                const days = ref([]);
                // Fix: Use local time instead of UTC to avoid -1 day error
                const setup = ref({ destination: 'Tokyo', startDate: getLocalISOString(), days: 5 });
                const editingTrip = ref({ destination: '', startDate: '', days: 1, color: '' });
                const googleScriptUrl = ref('');
                const checklist = ref([]);
                const isChecklistEditing = ref(false);
                const checklistData = ref(JSON.parse(JSON.stringify(DEFAULT_CHECKLIST_STRUCTURE)));
                const currentDayIdx = ref(0);
                const storageMode = computed(() => googleScriptUrl.value && googleScriptUrl.value.startsWith('http') ? 'cloud' : 'local');
                const isExporting = ref(false);
                
                const totalCost = computed(() => {
                    let total = 0;
                    days.value.forEach(d => {
                        total += (d.accommodationCost || 0);
                        d.items.forEach(i => total += (i.cost || 0));
                    });
                    return total;
                });
                const tripTotalExpense = totalCost;

                const currentTripColor = computed(() => {
                    if(!currentTripId.value) return null;
                    const t = tripList.value.find(x => x.id === currentTripId.value);
                    return t ? (t.color || BOOK_COLORS[0]) : BOOK_COLORS[0];
                });

                const categoryExpenses = computed(() => {
                    const map = {
                        accommodation: { id: 'accommodation', label: '住宿', icon: 'ph-bed', color: 'text-stone-500', bg: 'bg-stone-100', total: 0, list: [] },
                        flight: { id: 'flight', label: '飛航', icon: 'ph-airplane-tilt', color: 'text-gray-600', bg: 'bg-gray-100', total: 0, list: [] },
                        food: { id: 'food', label: '美食', icon: 'ph-fork-knife', color: 'text-orange-500', bg: 'bg-orange-50', total: 0, list: [] },
                        transport: { id: 'transport', label: '交通', icon: 'ph-train', color: 'text-blue-500', bg: 'bg-blue-50', total: 0, list: [] },
                        shop: { id: 'shop', label: '活動', icon: 'ph-confetti', color: 'text-pink-500', bg: 'bg-pink-50', total: 0, list: [] },
                        spot: { id: 'spot', label: '景點', icon: 'ph-mountains', color: 'text-green-600', bg: 'bg-green-50', total: 0, list: [] },
                    };
                    days.value.forEach((d, dIdx) => {
                        const dateStr = `Day ${dIdx + 1}`;
                        if (d.accommodationCost > 0) {
                            map.accommodation.total += d.accommodationCost;
                            map.accommodation.list.push({ desc: `${dateStr} ${d.accommodation || '住宿'}`, cost: d.accommodationCost });
                        }
                        d.items.forEach(i => {
                            if (i.cost > 0) {
                                const type = map[i.type] ? i.type : 'spot';
                                if (map[type]) {
                                    map[type].total += i.cost;
                                    let desc = i.activity || '未命名';
                                    if(i.type === 'flight') desc = `${i.airline || ''} ${i.flightNo || ''}`.trim();
                                    map[type].list.push({ desc: `${dateStr} ${desc}`, cost: i.cost });
                                }
                            }
                        });
                    });
                    return map;
                });
                const getTypeColor = (type) => ({ spot: 'bg-green-400', food: 'bg-orange-300', shop: 'bg-red-300', transport: 'bg-blue-300', flight: 'bg-gray-400' }[type] || 'bg-gray-400');
                const getCategoryName = (type) => ({ spot: '景點', food: '美食', shop: '活動', transport: '交通', flight: '飛航' }[type] || '其他');
                const getDayOfWeek = (date) => ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
                const toggleAccommodationType = (idx) => {
                    const day = days.value[idx];
                    if (!day.accommodationType) day.accommodationType = 'hotel';
                    day.accommodationType = day.accommodationType === 'flight' ? 'hotel' : 'flight';
                    if (day.accommodationType === 'flight') {
                        if(!day.airline) day.airline = ''; if(!day.flightNo) day.flightNo = ''; if(!day.origin) day.origin = ''; if(!day.destination) day.destination = '';
                        if(!day.flightDuration) day.flightDuration = ''; if(!day.time) day.time = ''; if(!day.arrivalTime) day.arrivalTime = ''; if(day.arrivalOffset === undefined) day.arrivalOffset = 0;
                    }
                };
                const cycleArrivalOffset = (obj) => { if (obj.arrivalOffset === undefined) obj.arrivalOffset = 0; obj.arrivalOffset += 1; if (obj.arrivalOffset > 2) obj.arrivalOffset = 0; };
                
                const formatDateFromISO = (val) => {
                    if (!val) return '';
                    if (typeof val === 'string' && val.indexOf('T') > -1) {
                        const date = new Date(val);
                        if (isNaN(date.getTime())) return val.split('T')[0];
                        const year = date.getFullYear();
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const day = date.getDate().toString().padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                    return val;
                };

                onMounted(() => {
                    const savedList = localStorage.getItem('travel_notebook_index');
                    const savedUrl = localStorage.getItem('travel_notebook_gas_url');
                    const savedTitle = localStorage.getItem('travel_notebook_title');
                    if (savedTitle) appTitle.value = savedTitle;
                    if (savedUrl) googleScriptUrl.value = savedUrl;
                    if (savedList) {
                        tripList.value = JSON.parse(savedList);
                        tripList.value.forEach(t => { if(!t.color || !BOOK_COLORS.includes(t.color)) t.color = BOOK_COLORS[0]; });
                    }
                });

                const saveAppTitle = () => { localStorage.setItem('travel_notebook_title', appTitle.value); };

                const switchTrip = async (id) => {
                    if (isLoading.value) return;
                    currentTripId.value = id;
                    viewState.value = 'notebook';
                    viewMode.value = 'list';
                    currentDayIdx.value = 0;
                    showSettings.value = false;
                    const localDataRaw = localStorage.getItem(`trip_${id}_data`);
                    let hasLocalData = false;
                    if (localDataRaw) {
                        try { const localData = JSON.parse(localDataRaw); days.value = localData.days; setup.value = localData.setup; checklist.value = localData.checklist || []; checklistData.value = localData.checklistData || JSON.parse(JSON.stringify(DEFAULT_CHECKLIST_STRUCTURE)); hasLocalData = true; } catch (e) {}
                    }
                    if (!hasLocalData) isLoading.value = true;
                    if (storageMode.value === 'cloud') {
                        fetch(`${googleScriptUrl.value}?sheet=${id}`).then(res => res.json()).then(json => {
                                if (Array.isArray(json) && json.length > 0) {
                                    const tripData = parseSheetDataToApp(json);
                                    days.value = tripData.days; setup.value = tripData.setup; checklist.value = tripData.checklist; checklistData.value = tripData.checklistData;
                                    localStorage.setItem(`trip_${id}_data`, JSON.stringify(tripData));
                                }
                            }).catch(e => { if (!hasLocalData) initEmptyDays(); }).finally(() => { isLoading.value = false; });
                    } else { if (!hasLocalData) { initEmptyDays(); isLoading.value = false; } }
                };

                const backToShelf = () => { if (currentTripId.value) saveData(); viewState.value = 'shelf'; currentTripId.value = null; };

                const saveData = async () => {
                    if (!currentTripId.value) return;
                    isSaving.value = true; saveStatus.value = '儲存中...';
                    const tripData = { days: days.value, setup: setup.value, checklist: checklist.value, checklistData: checklistData.value, lastModified: new Date().toISOString() };
                    localStorage.setItem(`trip_${currentTripId.value}_data`, JSON.stringify(tripData));
                    const idx = tripList.value.findIndex(t => t.id === currentTripId.value);
                    if (idx !== -1) { tripList.value[idx].destination = setup.value.destination; tripList.value[idx].startDate = setup.value.startDate; tripList.value[idx].daysCount = setup.value.days; localStorage.setItem('travel_notebook_index', JSON.stringify(tripList.value)); }
                    if (storageMode.value === 'cloud') {
                        try {
                            const flatData = flattenAppDataToSheet(tripData);
                            const indexData = tripList.value.map(t => [t.id, t.destination, t.startDate, t.daysCount, t.color]);
                            indexData.unshift(['ID', 'Destination', 'StartDate', 'Days', 'Color']);
                            const p1 = fetch(googleScriptUrl.value, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheetName: currentTripId.value, data: flatData }) });
                            const p2 = fetch(googleScriptUrl.value, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheetName: 'INDEX', data: indexData }) });
                            await Promise.all([p1, p2]); saveStatus.value = '已同步至雲端';
                        } catch (e) { saveStatus.value = '雲端同步失敗 (已存本機)'; }
                    } else { saveStatus.value = '已存於本機'; }
                    setTimeout(() => { saveStatus.value = ''; isSaving.value = false; }, 2000);
                };
                
                const uploadBookshelf = async () => {
                    if (!googleScriptUrl.value) { alert('請先設定 Google Apps Script 網址'); return; }
                    isLoading.value = true;
                    try {
                        const indexData = tripList.value.map(t => [t.id, t.destination, t.startDate, t.daysCount, t.color]);
                        indexData.unshift(['ID', 'Destination', 'StartDate', 'Days', 'Color']);
                        await fetch(googleScriptUrl.value, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheetName: 'INDEX', data: indexData }) });
                        alert('書架目錄已上傳！');
                    } catch(e) { console.error(e); alert('上傳失敗'); } finally { isLoading.value = false; }
                };
                
                const downloadBookshelf = async () => {
                    if (!googleScriptUrl.value) return;
                    isLoading.value = true;
                    try {
                        const res = await fetch(`${googleScriptUrl.value}?sheet=INDEX`);
                        const json = await res.json();
                        if (Array.isArray(json) && json.length > 0) {
                            tripList.value = json.map(row => ({ 
                                id: row.ID, 
                                destination: row.Destination || row.destination || '未命名行程', 
                                startDate: formatDateFromISO(row.StartDate || row.startDate || ''), 
                                daysCount: parseInt(row.Days || 0), 
                                color: row.Color 
                            }));
                            localStorage.setItem('travel_notebook_index', JSON.stringify(tripList.value));
                            alert('書架已從雲端同步完成！');
                        } else { alert('雲端找不到書架資料 (INDEX)，請確認您的 Google Sheet。'); }
                    } catch(e) { console.error(e); alert('下載失敗，請檢查網址或網路連線。'); } finally { isLoading.value = false; }
                };

                const flattenAppDataToSheet = (data) => {
                    const rows = [];
                    rows.push(['Day_Index', 'Date', 'Day_Stay', 'Day_Stay_Cost', 'Item_Time', 'Item_Type', 'Item_Activity', 'Item_Loc', 'Item_Cost', 'Item_Note', 'Setup_JSON', 'Checklist_JSON']);
                    const setupJson = JSON.stringify(data.setup);
                    const checklistPayload = { checked: data.checklist, structure: data.checklistData };
                    const checklistJson = JSON.stringify(checklistPayload);
                    data.days.forEach((day, dIdx) => {
                        let stayStr = day.accommodation || '';
                        if (day.accommodationType === 'flight') { stayStr = `[FLIGHT]${day.airline || ''}|${day.flightNo || ''}|${day.origin || ''}|${day.destination || ''}|${day.flightDuration || ''}|${day.time || ''}|${day.arrivalTime || ''}|${day.arrivalOffset || 0}`; }
                        if (day.items.length === 0) { rows.push([dIdx + 1, day.date, stayStr, day.accommodationCost, '', '', '', '', '', '', (dIdx===0 ? setupJson : ''), (dIdx===0 ? checklistJson : '')]); } 
                        else {
                            day.items.forEach((item, iIdx) => {
                                let activity = item.activity; let loc = item.location;
                                if (item.type === 'flight') { activity = `Flight: ${item.airline} ${item.flightNo} | Dur: ${item.flightDuration} | Arr: ${item.arrivalTime}${item.arrivalOffset ? ' (+' + item.arrivalOffset + ')' : ''}`; loc = `${item.origin} -> ${item.destination}`; }
                                rows.push([dIdx + 1, day.date, stayStr, day.accommodationCost, item.time, item.type, activity, loc, item.cost, item.note, (dIdx===0 && iIdx===0 ? setupJson : ''), (dIdx===0 && iIdx===0 ? checklistJson : '')]);
                            });
                        }
                    });
                    return rows;
                };

                const parseSheetDataToApp = (sheetData) => {
                    const newDays = []; let loadedSetup = null; let loadedChecklist = null; let loadedChecklistData = null; const dayMap = {};
                    sheetData.forEach(row => {
                        if (!row.Day_Index) return;
                        const dIdx = parseInt(row.Day_Index) - 1; if (isNaN(dIdx)) return;
                        if (row.Setup_JSON) { try { loadedSetup = JSON.parse(row.Setup_JSON); } catch(e){} }
                        if (row.Checklist_JSON) { try { const parsed = JSON.parse(row.Checklist_JSON); if (Array.isArray(parsed)) { loadedChecklist = parsed; loadedChecklistData = JSON.parse(JSON.stringify(DEFAULT_CHECKLIST_STRUCTURE)); } else { loadedChecklist = parsed.checked; loadedChecklistData = parsed.structure; } } catch(e){} }
                        if (!dayMap[dIdx]) { 
                            let accType = 'hotel'; let accName = row.Day_Stay; let f_airline='', f_no='', f_org='', f_dst='', f_dur='', f_time='', f_arr='', f_off=0;
                            if (accName && accName.startsWith('[FLIGHT]')) { accType = 'flight'; const raw = accName.replace('[FLIGHT]', ''); const parts = raw.split('|'); f_airline = parts[0] || ''; f_no = parts[1] || ''; f_org = parts[2] || ''; f_dst = parts[3] || ''; f_dur = parts[4] || ''; f_time = parts[5] || ''; f_arr = parts[6] || ''; f_off = parseInt(parts[7] || 0); accName = f_airline + ' ' + f_no; }
                            
                            let dateStr = row.Date;
                            if (dateStr && typeof dateStr === 'string' && dateStr.includes('T')) {
                                const d = new Date(dateStr);
                                if (!isNaN(d.getTime())) {
                                    dateStr = `${d.getMonth()+1}/${d.getDate()}(${getDayOfWeek(d)})`;
                                }
                            }
                            dayMap[dIdx] = { date: dateStr, accommodation: accName, accommodationCost: parseFloat(row.Day_Stay_Cost) || 0, accommodationType: accType, airline: f_airline, flightNo: f_no, origin: f_org, destination: f_dst, flightDuration: f_dur, time: f_time, arrivalTime: f_arr, arrivalOffset: f_off, items: [] }; 
                        }
                        if (row.Item_Type) {
                            let item = { time: formatTime(row.Item_Time), type: row.Item_Type, cost: parseFloat(row.Item_Cost) || 0, note: row.Item_Note };
                            if (row.Item_Type === 'flight') {
                                item.activity = ''; const parts = row.Item_Activity.split('|'); const flightPart = parts[0]?.split(':') || []; const durPart = parts[1]?.split(':') || []; const arrPart = parts[2]?.split(':') || []; const flightDetails = (flightPart[1] || '').trim().split(' ');
                                item.airline = flightDetails[0] || ''; item.flightNo = flightDetails[1] || ''; item.flightDuration = (durPart[1] || '').trim();
                                const rawArr = (arrPart[1] || '').trim(); const match = rawArr.match(/(\d{1,2}:\d{2})\s*(?:\(\+(\d+)\))?/); if (match) { item.arrivalTime = match[1]; item.arrivalOffset = parseInt(match[2] || 0); } else { item.arrivalTime = rawArr; item.arrivalOffset = 0; }
                                const locs = row.Item_Loc.split('->'); item.origin = locs[0]?.trim() || ''; item.destination = locs[1]?.trim() || '';
                            } else { item.activity = row.Item_Activity; item.location = row.Item_Loc; }
                            dayMap[dIdx].items.push(item);
                        }
                    });
                    const indices = Object.keys(dayMap).map(Number); const maxIdx = indices.length > 0 ? Math.max(...indices) : -1;
                    for(let i=0; i<=maxIdx; i++) { if (dayMap[i]) newDays.push(dayMap[i]); else newDays.push({ items:[] }); }
                    return { days: newDays, setup: loadedSetup || setup.value, checklist: loadedChecklist || [], checklistData: loadedChecklistData || JSON.parse(JSON.stringify(DEFAULT_CHECKLIST_STRUCTURE)) };
                };
                
                const formatTime = (t) => { if (!t) return ''; if (t.toString().includes('T')) return t.toString().split('T')[1].substring(0,5); return t; }
                const validateTime = (obj) => {
                    let input = (obj.time || '').trim(); if (!input) return;
                    input = input.replace(/[^0-9:]/g, '').replace(/：|\./g, ':');
                    let hh = 0, mm = 0;
                    if (!input.includes(':') && /^\d+$/.test(input)) { if (input.length === 4) { hh = parseInt(input.substring(0, 2)); mm = parseInt(input.substring(2)); } else if (input.length === 3) { hh = parseInt(input.substring(0, 1)); mm = parseInt(input.substring(1)); } else if (input.length <= 2) { hh = parseInt(input); mm = 0; } } else { const parts = input.split(':'); hh = parseInt(parts[0]) || 0; mm = parseInt(parts[1]) || 0; }
                    if (hh < 0) hh = 0; if (hh > 23) hh = 23; if (mm < 0) mm = 0; if (mm > 59) mm = 59;
                    obj.time = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;
                };
                const validateTimeSimple = (obj, key) => {
                    let input = (obj[key] || '').trim(); if (!input) return;
                    input = input.replace(/[^0-9:]/g, '').replace(/：|\./g, ':');
                    let hh = 0, mm = 0;
                    if (!input.includes(':') && /^\d+$/.test(input)) { if (input.length === 4) { hh = parseInt(input.substring(0, 2)); mm = parseInt(input.substring(2)); } else if (input.length === 3) { hh = parseInt(input.substring(0, 1)); mm = parseInt(input.substring(1)); } else if (input.length <= 2) { hh = parseInt(input); mm = 0; } } else { const parts = input.split(':'); hh = parseInt(parts[0]) || 0; mm = parseInt(parts[1]) || 0; }
                    if (hh < 0) hh = 0; if (hh > 23) hh = 23; if (mm < 0) mm = 0; if (mm > 59) mm = 59;
                    obj[key] = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;
                };
                const validateDuration = (obj) => {
                    let input = (obj.flightDuration || '').trim(); if (!input) return;
                    input = input.replace(/[^0-9\s]/g, ''); let hh = 0, mm = 0;
                    if (input.includes(' ')) { const parts = input.split(' '); hh = parseInt(parts[0]) || 0; mm = parseInt(parts[1]) || 0; } else if (/^\d+$/.test(input)) { if (input.length >= 3) { hh = parseInt(input.substring(0, input.length - 2)); mm = parseInt(input.substring(input.length - 2)); } else { hh = parseInt(input); mm = 0; } }
                    obj.flightDuration = `${hh}h ${mm.toString().padStart(2, '0')}m`;
                };
                const createNewTrip = () => { 
                    // Fix: Use getLocalISOString
                    setup.value = { destination: '', startDate: getLocalISOString(), days: 3 }; 
                    showSetupModal.value = true; 
                    showSettings.value = false; 
                };
                const initTrip = () => {
                    if (!setup.value.destination) { alert('請輸入目的地'); return; }
                    const newId = 'trip_' + Date.now().toString(36);
                    currentTripId.value = newId;
                    const randomColor = BOOK_COLORS[Math.floor(Math.random() * BOOK_COLORS.length)];
                    const newDays = []; const start = new Date(setup.value.startDate);
                    for (let i = 0; i < setup.value.days; i++) { const curr = new Date(start); curr.setDate(start.getDate() + i); const mm = curr.getMonth() + 1; const dd = curr.getDate(); const wd = getDayOfWeek(curr); newDays.push({ date: `${mm}/${dd}(${wd})`, accommodation: '', accommodationCost: 0, items: [] }); }
                    days.value = newDays; checklist.value = []; checklistData.value = JSON.parse(JSON.stringify(DEFAULT_CHECKLIST_STRUCTURE));
                    tripList.value.unshift({ id: newId, destination: setup.value.destination, startDate: setup.value.startDate, daysCount: setup.value.days, color: randomColor });
                    localStorage.setItem('travel_notebook_index', JSON.stringify(tripList.value));
                    showSetupModal.value = false;
                    saveData();
                };
                const openDeleteModal = (id) => { deleteTargetType.value = 'trip'; deleteTargetId.value = id; deleteTitle.value = '刪除旅遊筆記？'; deleteMessage.value = '確定要從書架上永久移除這本筆記嗎？此操作無法復原。'; showDeleteModal.value = true; };
                const confirmRemoveDay = (idx) => { deleteTargetType.value = 'day'; deleteTargetId.value = idx; deleteTitle.value = '撕掉這一頁？'; deleteMessage.value = '確定要刪除這一天嗎？所有的行程紀錄都將消失。'; showDeleteModal.value = true; }
                const closeDeleteModal = () => { showDeleteModal.value = false; deleteTargetType.value = null; deleteTargetId.value = null; };
                const confirmDeleteAction = () => {
                    if (deleteTargetType.value === 'trip') {
                        const id = deleteTargetId.value; tripList.value = tripList.value.filter(t => t.id !== id);
                        localStorage.setItem('travel_notebook_index', JSON.stringify(tripList.value)); localStorage.removeItem(`trip_${id}_data`);
                        if (currentTripId.value === id) { currentTripId.value = null; viewState.value = 'shelf'; }
                    } else if (deleteTargetType.value === 'day') { const idx = deleteTargetId.value; days.value.splice(idx, 1); setup.value.days = days.value.length; }
                    closeDeleteModal();
                };
                const saveSettingsAndTrip = () => {
                    localStorage.setItem('travel_notebook_gas_url', googleScriptUrl.value);
                    if (currentTripId.value) {
                        const diff = setup.value.days - days.value.length;
                        if (diff > 0) { for(let i=0; i<diff; i++) days.value.push({ items:[], accommodation:'', accommodationCost:0, date:'' }); } 
                        else if (diff < 0) { if(confirm(`減少了 ${Math.abs(diff)} 天，確定刪除後面的行程嗎？`)) { days.value.splice(days.value.length + diff, Math.abs(diff)); } else { setup.value.days = days.value.length; } }
                        saveData();
                        if (googleScriptUrl.value) { uploadBookshelf(); }
                    }
                    showSettings.value = false; showSetupModal.value = false;
                };
                
                const closeSettings = () => { 
                    showSettings.value = false; 
                    showSetupModal.value = false; 
                    showEditTripModal.value = false;
                    showManualModal.value = false;
                };
                
                const initEmptyDays = () => { days.value = []; };
                const addItem = (dIdx) => { days.value[dIdx].items.push({ time: '', type: 'spot', cost: '', note: '', activity: '', location: '', arrivalOffset: 0 }); };
                const removeItem = (dIdx, iIdx) => { days.value[dIdx].items.splice(iIdx, 1); };
                const addDay = () => { days.value.push({ date: 'New Day', accommodation: '', accommodationCost: 0, items: [] }); setup.value.days = days.value.length; };
                const removeDay = (idx) => { confirmRemoveDay(idx); };
                const changeViewMode = (mode) => { viewMode.value = mode; };
                const changeDay = (idx) => { viewMode.value = 'list'; currentDayIdx.value = idx; }
                const toggleCheckItem = (item) => { const idx = checklist.value.indexOf(item); if (idx === -1) { checklist.value.push(item); } else { checklist.value.splice(idx, 1); } saveData(); };
                const toggleChecklistEdit = () => { if (isChecklistEditing.value) { cleanChecklist(); saveData(); } isChecklistEditing.value = !isChecklistEditing.value; };
                const cleanChecklist = () => { const allItems = new Set(); Object.values(checklistData.value).forEach(items => { items.forEach(i => allItems.add(i)); }); checklist.value = checklist.value.filter(i => allItems.has(i)); };
                const addChecklistItem = (category) => { checklistData.value[category].push("新項目"); };
                const removeChecklistItem = (category, index) => { checklistData.value[category].splice(index, 1); };
                const addChecklistCategory = () => { const name = prompt("請輸入新分類名稱：", "新分類"); if (name && !checklistData.value[name]) { checklistData.value[name] = []; } };
                const removeChecklistCategory = (category) => { if(confirm(`確定刪除分類「${category}」及其所有項目嗎？`)) { delete checklistData.value[category]; } };
                const openManual = () => { showManualModal.value = true; manualTab.value = 'setup'; };
                
                const openEditTripModal = () => {
                    const currentTrip = tripList.value.find(t => t.id === currentTripId.value);
                    editingTrip.value = { 
                        destination: setup.value.destination, 
                        startDate: setup.value.startDate, 
                        days: setup.value.days,
                        color: currentTrip ? (currentTrip.color || BOOK_COLORS[0]) : BOOK_COLORS[0]
                    };
                    showEditTripModal.value = true;
                };

                const confirmEditTrip = () => {
                    if (!editingTrip.value.destination) { alert('請輸入目的地'); return; }
                    if (editingTrip.value.days < 1) { alert('天數至少為 1 天'); return; }
                    
                    const oldDaysCount = days.value.length;
                    const newDaysCount = editingTrip.value.days;
                    const diff = newDaysCount - oldDaysCount;

                    if (diff < 0) {
                        if(!confirm(`您將旅程縮短了 ${Math.abs(diff)} 天，這些天數的行程資料將會被刪除。確定嗎？`)) {
                            return;
                        }
                    }

                    setup.value.destination = editingTrip.value.destination;
                    setup.value.startDate = editingTrip.value.startDate;
                    setup.value.days = editingTrip.value.days;

                    const tripIdx = tripList.value.findIndex(t => t.id === currentTripId.value);
                    if (tripIdx !== -1) {
                        tripList.value[tripIdx].destination = editingTrip.value.destination;
                        tripList.value[tripIdx].startDate = editingTrip.value.startDate;
                        tripList.value[tripIdx].daysCount = editingTrip.value.days;
                        tripList.value[tripIdx].color = editingTrip.value.color;
                        localStorage.setItem('travel_notebook_index', JSON.stringify(tripList.value));
                    }

                    if (diff > 0) {
                        for(let i=0; i<diff; i++) {
                            days.value.push({ items:[], accommodation:'', accommodationCost:0, date:'' });
                        }
                    } else if (diff < 0) {
                        days.value.splice(newDaysCount, Math.abs(diff));
                    }

                    const start = new Date(setup.value.startDate);
                    days.value.forEach((day, index) => {
                        const curr = new Date(start);
                        curr.setDate(start.getDate() + index);
                        const mm = curr.getMonth() + 1;
                        const dd = curr.getDate();
                        const wd = getDayOfWeek(curr);
                        day.date = `${mm}/${dd}(${wd})`;
                    });

                    saveData();
                    if (googleScriptUrl.value) { uploadBookshelf(); }
                    showEditTripModal.value = false;
                    alert('旅程資訊已更新！');
                };
                
                const exportToPDF = async () => {
                    document.title = (setup.value.destination || 'Travel Notebook') + " - " + setup.value.startDate;
                    
                    isExporting.value = true;
                    await nextTick();

                    // Fix: Simplification. Trust browser pagination with CSS rules instead of manual JS resizing
                    // This allows contents to flow naturally and respect 'break-after: always'
                    
                    setTimeout(() => {
                        window.focus(); 
                        window.print();
                        isExporting.value = false;
                    }, 500);
                };

                const saveDataAndUpload = async () => {
                    await saveData();
                    if(storageMode.value === 'cloud') {
                         alert('行程已儲存！');
                    } else {
                         alert('行程已儲存至本機！');
                    }
                };

                return {
                    viewState, showSettings, showSetupModal, isLoading, isSaving, saveStatus,
                    tripList, currentTripId, days, setup, googleScriptUrl, storageMode, totalCost, currentDayIdx, backToShelf, currentTripColor,
                    switchTrip, createNewTrip, initTrip, saveData, addItem, removeItem, addDay, removeDay, changeDay, saveSettingsAndTrip, closeSettings,
                    appTitle, saveAppTitle, showDeleteModal, deleteTitle, deleteMessage, openDeleteModal, closeDeleteModal, confirmDeleteAction, confirmRemoveDay,
                    validateTime, validateTimeSimple, validateDuration, viewMode, changeViewMode, participants, tripTotalExpense, 
                    checklist, checklistData, toggleCheckItem, categoryExpenses, isChecklistEditing, toggleChecklistEdit, addChecklistItem, removeChecklistItem, addChecklistCategory, removeChecklistCategory,
                    getCategoryName, toggleAccommodationType, cycleArrivalOffset, downloadBookshelf, uploadBookshelf, showManualModal, manualTab, openManual,
                    getTypeColor, showEditTripModal, editingTrip, openEditTripModal, confirmEditTrip, BOOK_COLORS, exportToPDF, isExporting,
                    saveDataAndUpload
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
